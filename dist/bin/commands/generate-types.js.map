{"version":3,"sources":["../../../src/bin/commands/generate-types.js"],"names":["command","desc","builder","yargs","options","description","type","demand","dialect","choices","default","handler","argv","defaultFormatTypeName","tableName","defaultFormatPropertyName","columnName","filterColumns","columnFilter","Function","formatTypeName","typeNameFormatter","formatPropertyName","propertyNameFormatter","createProperties","columns","filteredColumns","filter","column","map","name","databaseType","nullable","typeName","connection","databaseConnectionUri","unnormalizedColumns","includeMaterializedViews","concat","normalizedColumns","properties","console","log","end"],"mappings":";;;;;;;AAIA;;AAIA;;AAOA;;AAIA;;;;AAjBA;;AAuBO,MAAMA,4BAAU,gBAAhB;AACA,MAAMC,sBAAO,yCAAb;;AAWA,MAAMC,4BAAWC,KAAD,IAAoB;AACzCA,QACGC,OADH,CACW;AACP,qBAAiB;AACfC,mBAAa,gOADE;AAEfC,YAAM;AAFS,KADV;AAKP,+BAA2B;AACzBC,cAAQ;AADiB,KALpB;AAQPC,aAAS;AACPC,eAAS,CACP,MADO,CADF;AAIPF,cAAQ;AAJD,KARF;AAcP,kCAA8B;AAC5BG,eAAS,IADmB;AAE5BJ,YAAM;AAFsB,KAdvB;AAkBP,+BAA2B;AACzBI,eAAS,IADgB;AAEzBL,mBAAa,4OAFY;AAGzBC,YAAM;AAHmB,KAlBpB;AAuBP,2BAAuB;AACrBI,eAAS,IADY;AAErBL,mBAAa,qQAFQ;AAGrBC,YAAM;AAHe;AAvBhB,GADX;AA8BD,CA/BM;;AAoCA,MAAMK;AAAA,+BAAU,WAAOC,IAAP,EAAkD;AACvE,UAAMC,wBAAwB,SAAxBA,qBAAwB,CAACC,SAAD,EAA+B;AAC3D,aAAO,wBAAW,uBAAUA,SAAV,CAAX,IAAmC,QAA1C;AACD,KAFD;;AAIA,UAAMC,4BAA4B,SAA5BA,yBAA4B,CAACC,UAAD,EAAgC;AAChE,aAAO,uBAAUA,UAAV,CAAP;AACD,KAFD;;AAIA;AACA,UAAMC,gBAAmCL,KAAKM,YAAL,GAAoB,IAAIC,QAAJ,CAAa,WAAb,EAA0B,YAA1B,EAAwCP,KAAKM,YAA7C,CAApB,GAAiF,IAA1H;;AAEA;AACA,UAAME,iBAAiCR,KAAKS,iBAAL,GAAyB,IAAIF,QAAJ,CAAa,YAAb,EAA2BP,KAAKS,iBAAhC,CAAzB,GAA8ER,qBAArH;AACA;AACA,UAAMS,qBAAqCV,KAAKW,qBAAL,GAA6B,IAAIJ,QAAJ,CAAa,WAAb,EAA0BP,KAAKW,qBAA/B,CAA7B,GAAqFR,yBAAhI;;AAEA,UAAMS,mBAAmB,SAAnBA,gBAAmB,CAACC,OAAD,EAA2E;AAClG,UAAIC,kBAAkBD,OAAtB;;AAEA,UAAIR,aAAJ,EAAmB;AACjBS,0BAAkBA,gBAAgBC,MAAhB,CAAuB,UAACC,MAAD,EAAY;AACnD;AACA,iBAAOX,cAAcW,OAAOd,SAArB,EAAgCc,OAAOZ,UAAvC,CAAP;AACD,SAHiB,CAAlB;AAID;;AAED,aAAOU,gBAAgBG,GAAhB,CAAoB,UAACD,MAAD,EAAY;AACrC,eAAO;AACLE,gBAAMR,mBAAmBM,OAAOZ,UAA1B,CADD;AAELV,gBAAM,4BAAYsB,OAAOG,YAAnB,KAAoCH,OAAOI,QAAP,GAAkB,SAAlB,GAA8B,EAAlE,CAFD;AAGLC,oBAAUb,eAAeQ,OAAOd,SAAtB;AAHL,SAAP;AAKD,OANM,CAAP;AAOD,KAjBD;;AAmBA,UAAMoB,aAAa,MAAM,gCAAiBtB,KAAKuB,qBAAtB,CAAzB;;AAEA,QAAIC,mBAAJ;;AAEAA,0BAAsB,MAAM,sCAAwBF,UAAxB,CAA5B;;AAEA,QAAItB,KAAKyB,wBAAT,EAAmC;AACjCD,4BAAsBA,oBAAoBE,MAApB,EAA2B,MAAM,iDAAmCJ,UAAnC,CAAjC,EAAtB;AACD;;AAED,UAAMK,oBAAoB,iCAAiBH,mBAAjB,CAA1B;;AAEA,UAAMI,aAAahB,iBAAiBe,iBAAjB,CAAnB;;AAEA;AACAE,YAAQC,GAAR,CAAY,yCAAyBF,UAAzB,CAAZ;;AAEA,UAAMN,WAAWS,GAAX,EAAN;AACD,GAtDY;;AAAA;AAAA;AAAA;AAAA,IAAN","file":"generate-types.js","sourcesContent":["// @flow\n\n/* eslint-disable no-new-func */\n\nimport {\n  camelCase,\n  upperFirst\n} from 'lodash';\nimport {\n  createConnection\n} from 'mightyql';\nimport type {\n  ColumnType,\n  TypePropertyType\n} from '../../types';\nimport {\n  getDatabaseTableColumns,\n  getDatabaseMaterializedViewColumns\n} from '../../queries';\nimport {\n  generateFlowTypeDocument,\n  mapFlowType,\n  normalizeColumns\n} from '../../utilities';\n\nexport const command = 'generate-types';\nexport const desc = 'Generate types for a Postgres database.';\n\ntype ConfigurationType = {|\n  +columnFilter: string,\n  +databaseConnectionUri: string,\n  +dialect: 'flow',\n  +includeMaterializedViews: boolean,\n  +propertyNameFormatter: string | null,\n  +typeNameFormatter: string | null\n|};\n\nexport const builder = (yargs: *): void => {\n  yargs\n    .options({\n      'column-filter': {\n        description: 'Function used to filter columns. Function is constructed using `new Function`. Function receives table name as the first parameter and column name as the second parameter (parameter names are \"tableName\" and \"columnName\").',\n        type: 'string'\n      },\n      'database-connection-uri': {\n        demand: true\n      },\n      dialect: {\n        choices: [\n          'flow'\n        ],\n        demand: true\n      },\n      'include-materialized-views': {\n        default: true,\n        type: 'boolean'\n      },\n      'property-name-formatter': {\n        default: null,\n        description: 'Function used to format property name. Function is constructed using `new Function`. Function receives column name as the first parameter (parameter name is \"columnName\"). The default behaviour is to (lower) camelCase the column name.',\n        type: 'string'\n      },\n      'type-name-formatter': {\n        default: null,\n        description: 'Function used to format type name. Function is constructed using `new Function`. Function receives table name as the first parameter (parameter name is \"tableName\"). The default behaviour is to (upper) CamelCase the table name and suffix it with \"RecordType\".',\n        type: 'string'\n      }\n    });\n};\n\ntype ColumnFilterType = (tableName: string, columnName: string) => boolean;\ntype FormatterType = (name: string) => string;\n\nexport const handler = async (argv: ConfigurationType): Promise<void> => {\n  const defaultFormatTypeName = (tableName: string): string => {\n    return upperFirst(camelCase(tableName)) + 'Record';\n  };\n\n  const defaultFormatPropertyName = (columnName: string): string => {\n    return camelCase(columnName);\n  };\n\n  // eslint-disable-next-line no-extra-parens\n  const filterColumns: ColumnFilterType = (argv.columnFilter ? new Function('tableName', 'columnName', argv.columnFilter) : null: any);\n\n  // eslint-disable-next-line no-extra-parens\n  const formatTypeName: FormatterType = (argv.typeNameFormatter ? new Function('columnName', argv.typeNameFormatter) : defaultFormatTypeName: any);\n  // eslint-disable-next-line no-extra-parens\n  const formatPropertyName: FormatterType = (argv.propertyNameFormatter ? new Function('tableName', argv.propertyNameFormatter) : defaultFormatPropertyName: any);\n\n  const createProperties = (columns: $ReadOnlyArray<ColumnType>): $ReadOnlyArray<TypePropertyType> => {\n    let filteredColumns = columns;\n\n    if (filterColumns) {\n      filteredColumns = filteredColumns.filter((column) => {\n        // $FlowFixMe\n        return filterColumns(column.tableName, column.columnName);\n      });\n    }\n\n    return filteredColumns.map((column) => {\n      return {\n        name: formatPropertyName(column.columnName),\n        type: mapFlowType(column.databaseType) + (column.nullable ? ' | null' : ''),\n        typeName: formatTypeName(column.tableName)\n      };\n    });\n  };\n\n  const connection = await createConnection(argv.databaseConnectionUri);\n\n  let unnormalizedColumns;\n\n  unnormalizedColumns = await getDatabaseTableColumns(connection);\n\n  if (argv.includeMaterializedViews) {\n    unnormalizedColumns = unnormalizedColumns.concat(await getDatabaseMaterializedViewColumns(connection));\n  }\n\n  const normalizedColumns = normalizeColumns(unnormalizedColumns);\n\n  const properties = createProperties(normalizedColumns);\n\n  // eslint-disable-next-line no-console\n  console.log(generateFlowTypeDocument(properties));\n\n  await connection.end();\n};\n"]}